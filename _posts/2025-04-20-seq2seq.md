---
title: Seq2seq
date: 2025-04-20 10:00:00 +0800
categories: [Paper Reading, Replicating]
tags: [Replicate, sequence]
math: true
---

Orginal Paper:  [Sequence to Sequence Learning with Neural Networks](https://arxiv.org/pdf/1409.3215)

### 1. å¼•è¨€

Seq2seqå‡ºç°äº2014å¹´ï¼Œå½“æ—¶æ·±åº¦å­¦ä¹ çš„å¼ºå¤§æ­£åœ¨é€æ¸è¢«äººä»¬æ‰€è®¤è¯†ï¼Œå¹¶ä¸”éšç€è¯¸å¦‚ReLUï¼ŒAdamç­‰æ·±åº¦å­¦ä¹ æŠ€æœ¯é€æ¸å‡ºç°å¹¶æˆç†Ÿï¼Œç ”ç©¶äººå‘˜æœ‰æ„ä½¿ç”¨è“¬å‹ƒå‘å±•çš„æ·±åº¦å­¦ä¹ æŠ€æœ¯æ¥æŒ‘æˆ˜ä¼ ç»Ÿç»Ÿè®¡ç®—æ³•åœ¨åºåˆ—ä»»åŠ¡ä¸­çš„åœ°ä½ã€‚

æœ¬æ–‡çš„ä¸»è¦è´¡çŒ®æ˜¯è®¾è®¡äº†ä¸€ç§ä»¥DNNï¼ˆDeep Neural Networkï¼‰ä¸ºæ ¸å¿ƒï¼ŒåŒæ—¶èƒ½å¤Ÿè¿›è¡Œç«¯åˆ°ç«¯è®­ç»ƒçš„ç»“æ„ã€‚è¿™ä¸ªç»“æ„çš„ä¸»è¦ä¼˜åŠ¿æ˜¯ï¼š

+ å¯¹è¾“å…¥å’Œè¾“å‡ºçš„é•¿åº¦æ²¡æœ‰ä¸¥æ ¼è¦æ±‚ï¼Œèƒ½å¤Ÿå¼€å±•é€šç”¨çš„ï¼Œä¸é™é•¿åº¦çš„ç«¯åˆ°ç«¯åºåˆ—è®­ç»ƒ
+ ç¼–ç å™¨è§£ç å™¨äº’ç›¸ç‹¬ç«‹ï¼Œèƒ½å¤Ÿé€‚é…ä¸åŒç§ç±»åºåˆ—çš„ä»»åŠ¡
+ ç¼–ç å™¨å’Œè§£ç å™¨ä¸­é—´ä½¿ç”¨ä¸€ä¸ªå‹ç¼©çš„éšè—çŠ¶æ€è”ç³»ï¼Œä½¿å¾—è§£ç å™¨ç”Ÿæˆçš„å†…å®¹å¯ä»¥å‚è€ƒæ‰€æœ‰çš„éšè—çŠ¶æ€ï¼Œè€Œä¸éœ€è¦å’Œç¼–ç å™¨è¾“å…¥çš„å†…å®¹ä¸€ä¸€å¯¹åº”



### 2. Seq2seqçš„å®ç°

æ–‡ä¸­å…³äºRNNçš„å®šä¹‰å¦‚å›¾ï¼š

![image-20250421152944825](assets/image-20250421152944825.png)

æ ¹æ®è¯¥å®šä¹‰æˆ‘ä»¬å¯ä»¥å¾ˆè½»æ˜“åœ°ç”»å‡ºRNNçš„è‰å›¾ï¼š

<img src="assets/IMG_0971.jpeg" alt="IMG_0971" style="zoom: 25%;" />

è€Œå…·ä½“å®ç°çš„æ—¶å€™ï¼Œå› ä¸ºç¼–ç å™¨éƒ¨åˆ†å¹¶ä¸éœ€è¦è¿›è¡Œä»»ä½•è¾“å‡ºï¼Œæ‰€ä»¥ä¹Ÿä¸éœ€yhçŸ©é˜µï¼Œå®ç°å¦‚ä¸‹ï¼š

```python
class Seq_1(nn.Module):
    def __init__(self):
        super(Seq_1, self).__init__()
        self.xh = nn.Sequential(
            nn.Linear(cfg.embedding_size, cfg.hidden_size*2),
            nn.ReLU(),
            nn.Linear(cfg.hidden_size*2, cfg.hidden_size//2),
            nn.ReLU(),
            nn.Linear(cfg.hidden_size//2, cfg.hidden_size)
        )
        self.hh = nn.Sequential(
            nn.Linear(cfg.hidden_size, cfg.hidden_size*2),
            nn.ReLU(),
            nn.Linear(cfg.hidden_size*2, cfg.hidden_size//2),
            nn.ReLU(),
            nn.Linear(cfg.hidden_size//2, cfg.hidden_size)
        )
        self.sigmoid = nn.Sigmoid()
        self.tanh = nn.Tanh()

    def forward(self, seq, input_lengths):
        batch_size, seq_len, embedding_size = seq.size()
        mask = torch.arange(seq_len, device=cfg.device).expand(batch_size, -1) < input_lengths.unsqueeze(1)

        hidden_state = torch.zeros(batch_size, cfg.hidden_size, device=cfg.device)

        for t in range(seq_len):
            token = seq[:,t,:]
            current_mask = mask[:, t].unsqueeze(1)
            temp_hidden_state = self.tanh(self.xh(token)+self.hh(hidden_state))
            hidden_state = torch.where(current_mask, temp_hidden_state, hidden_state)
            
        return hidden_state
```

å› ä¸ºæ¨¡å‹è®­ç»ƒçš„æ—¶å€™æ˜¯ä»¥batchæ¥è®­ç»ƒçš„ï¼Œä½†æ˜¯batchä¸­çš„æ¯ä¸€ä¸ªæ ·æœ¬çš„é•¿åº¦å¹¶ä¸æ˜¯ä¸€æ ·çš„ï¼Œæ‰€ä»¥åœ¨æ¯ä¸€ä¸ªå¾ªç¯ç»“æŸä¹‹åæˆ‘ä»¬éœ€è¦åˆ¤æ–­æŸæ ·æœ¬åœ¨è¿™ä¸ªå¾ªç¯å½“ä¸­æ˜¯å¦éœ€è¦æ›´æ–°ï¼Œä»¥é¿å…ä¸åˆç†çš„è®¡ç®—ã€‚åŒæ—¶æˆ‘ä»¬å°†hidden_stateåˆå§‹åŒ–ä¸ºå…¨é›¶çŸ©é˜µ

ä»¥ä¸‹æ˜¯è§£ç å™¨çš„å®ç°ï¼š
```python
class Seq_2(nn.Module):
    def __init__(self):
        super(Seq_2, self).__init__()
        self.hh = nn.Sequential(
            nn.Linear(cfg.hidden_size, cfg.hidden_size*2),
            nn.ReLU(),
            nn.Linear(cfg.hidden_size*2, cfg.hidden_size//2),
            nn.ReLU(),
            nn.Linear(cfg.hidden_size//2, cfg.hidden_size),
            nn.ReLU()
        )
        self.hv = nn.Sequential(
            nn.Linear(cfg.hidden_size, cfg.hidden_size*2),
            nn.ReLU(),
            nn.Linear(cfg.hidden_size*2, cfg.hidden_size//2),
            nn.ReLU(),
            nn.Linear(cfg.hidden_size//2, cfg.vocab_size)
        )
        self.sigmoid = nn.Sigmoid()

    def forward(self, hidden_state, decode_length):
        batch_size, _ = hidden_state.size()
        outputs = torch.zeros(batch_size, decode_length, cfg.vocab_size, device=cfg.device) # this tensor have a continual ram space, use it to avoid using torch.cat(), which cause O(n^2) complexity
        
        for t in range(decode_length):
            hidden_state = self.hh(hidden_state)
            outputs[:,t,:] = self.hv(hidden_state)
    
        return outputs
```

è§£ç å™¨çš„å®ç°æ¯”ç¼–ç å™¨ç®€å•å¾ˆå¤šï¼Œå¹¶ä¸”å¤šäº†hyçŸ©é˜µç”¨æ¥å°†éšè—çŠ¶æ€æ˜ å°„ä¸ºè¾“å‡ºã€‚



### 3. å®éªŒè®¾è®¡

æ­£å¦‚Seq2seqè®¾è®¡ä¹‹å‡ºæ‰€è®¾æƒ³çš„ä¸€æ ·ï¼Œå®ƒå‡ ä¹å¯ä»¥å®Œæˆä»»ä½•åºåˆ—åˆ°åºåˆ—ä»»åŠ¡çš„è®­ç»ƒã€‚æˆ‘è®¾è®¡äº†ä¸€ä¸ªç®€å•ç›´è§‚çš„ä»»åŠ¡ï¼Œå¹¶ä¸”å¯ä»¥å¾ˆå¥½åˆ©ç”¨ä¸ŠSeq2seqçš„ç‰¹æ€§ã€‚

**ä»»åŠ¡å®šä¹‰ï¼šè´¨æ•°åºåˆ—æå–ä»»åŠ¡**

**è¾“å…¥**
- ä¸€ä¸ªæ•´æ•°åºåˆ— $$ x = [x_1, x_2, \dots, x_n] $$ï¼Œå…¶ä¸­ï¼š
  - åºåˆ—é•¿åº¦ $$ n \leq \text{max\_length} $$ã€‚
  - æ¯ä¸ªæ•´æ•° \(x_i\) æ»¡è¶³ \(1 \leq x_i \leq \text{cfg.vocab\_size} - 2\)ã€‚

**è¾“å‡º**
- ä¸€ä¸ªæ•´æ•°åºåˆ— \(y = [y_1, y_2, \dots, y_m]\)ï¼Œå…¶ä¸­ï¼š
  - è¾“å‡ºåºåˆ— \(y\) æ˜¯è¾“å…¥åºåˆ—ä¸­æ‰€æœ‰è´¨æ•°çš„åºåˆ—ã€‚
  - è´¨æ•°å®šä¹‰ä¸ºï¼šå¤§äº 1 ä¸”ä»…èƒ½è¢« 1 å’Œè‡ªèº«æ•´é™¤çš„æ•´æ•°ã€‚
  - è¾“å‡ºåºåˆ—é•¿åº¦ \(m \leq n\)ã€‚

**ä»»åŠ¡ç›®æ ‡**
- è®¾è®¡ä¸€ä¸ª **seq2seq æ¨¡å‹**ï¼Œå­¦ä¹ ä»è¾“å…¥åºåˆ— \(x\) æ˜ å°„åˆ°è¾“å‡ºåºåˆ— \(y\) çš„è§„åˆ™ã€‚
- æ¨¡å‹é€šè¿‡è®­ç»ƒåï¼Œèƒ½å¤Ÿå‡†ç¡®é¢„æµ‹è¾“å…¥åºåˆ—ä¸­çš„è´¨æ•°åºåˆ—ã€‚

---

**è®­ç»ƒä¸è¯„ä¼°æµç¨‹**

**è®­ç»ƒ**
- è®­ç»ƒæ¨¡å‹è¿›è¡Œå¤šè½®è¿­ä»£ï¼Œæ¯è½®è®­ç»ƒè¿›è¡Œ \( \text{steps} \) æ¬¡æ›´æ–°ã€‚
- æ¯æ¬¡è®­ç»ƒåï¼Œæ¨¡å‹ä¼šä¿å­˜å¹¶ç”¨äºè¯„ä¼°ã€‚

 **è¯„ä¼°**
- è¯„ä¼°æ¨¡å‹çš„æ€§èƒ½æ—¶ï¼Œè¿è¡Œ \( \text{evaluate\_round} \) æ¬¡ç‹¬ç«‹è¯„ä¼°ï¼Œç»Ÿè®¡ä»¥ä¸‹æŒ‡æ ‡çš„å¹³å‡å€¼ï¼š
  1. **PSA**ï¼ˆä½ç½®åºåˆ—å‡†ç¡®ç‡ï¼‰
  2. **LCSR**ï¼ˆæœ€é•¿å…¬å…±å­åºåˆ—æ¯”ç‡ï¼‰
  3. **GeoMean**ï¼ˆPSA å’Œ LCSR çš„å‡ ä½•å¹³å‡å€¼ï¼‰

---

**è¯„ä¼°æŒ‡æ ‡å®šä¹‰**

**1. PSAï¼ˆPosition Sequence Accuracyï¼‰**
PSA è¡¡é‡é¢„æµ‹åºåˆ—ä¸ç›®æ ‡åºåˆ—åœ¨æ¯ä¸ªä½ç½®ä¸Šçš„åŒ¹é…ç¨‹åº¦ã€‚å¯¹äºç¬¬ \(i\) ä¸ªæ ·æœ¬ï¼š
\[
\text{PSA}^{(i)} = \frac{1}{L_i} \sum_{k=1}^{L_i} \delta\left(y_k^{(i)}, \hat{y}_k^{(i)}\right)
\]
å…¶ä¸­ï¼š
- \(L_i\)ï¼šç›®æ ‡åºåˆ— \(y^{(i)}\) çš„é•¿åº¦ã€‚
- \(\delta(y_k^{(i)}, \hat{y}_k^{(i)})\)ï¼šæŒ‡ç¤ºå‡½æ•°ï¼Œå½“ \(y_k^{(i)} = \hat{y}_k^{(i)}\) æ—¶å–å€¼ 1ï¼Œå¦åˆ™å–å€¼ 0ã€‚
- \(y_k^{(i)}\)ï¼šç›®æ ‡åºåˆ—çš„ç¬¬ \(k\) ä¸ªå…ƒç´ ã€‚
- \(\hat{y}_k^{(i)}\)ï¼šé¢„æµ‹åºåˆ—çš„ç¬¬ \(k\) ä¸ªå…ƒç´ ã€‚

æ•´ä½“ PSA ä¸ºæ‰€æœ‰æ ·æœ¬çš„å¹³å‡å€¼ï¼š
\[
\text{PSA} = \frac{1}{N} \sum_{i=1}^{N} \text{PSA}^{(i)}
\]
å…¶ä¸­ \(N\) æ˜¯æ ·æœ¬æ€»æ•°ã€‚

---

 **2. LCSRï¼ˆLongest Common Subsequence Ratioï¼‰**
LCSR è¡¡é‡é¢„æµ‹åºåˆ—ä¸ç›®æ ‡åºåˆ—çš„æœ€é•¿å…¬å…±å­åºåˆ—ï¼ˆLCSï¼‰çš„æ¯”ä¾‹ã€‚å¯¹äºç¬¬ \(i\) ä¸ªæ ·æœ¬ï¼š
\[
\text{LCSR}^{(i)} = \frac{\text{LCS}(y^{(i)}, \hat{y}^{(i)})}{L_i}
\]
å…¶ä¸­ï¼š
- \(\text{LCS}(y^{(i)}, \hat{y}^{(i)})\)ï¼šç›®æ ‡åºåˆ— \(y^{(i)}\) å’Œé¢„æµ‹åºåˆ— \(\hat{y}^{(i)}\) çš„æœ€é•¿å…¬å…±å­åºåˆ—é•¿åº¦ã€‚
- \(L_i\)ï¼šç›®æ ‡åºåˆ— \(y^{(i)}\) çš„é•¿åº¦ã€‚

æ•´ä½“ LCSR ä¸ºæ‰€æœ‰æ ·æœ¬çš„å¹³å‡å€¼ï¼š
\[
\text{LCSR} = \frac{1}{N} \sum_{i=1}^{N} \text{LCSR}^{(i)}
\]

---

 **3. GeoMeanï¼ˆGeometric Meanï¼‰**
GeoMean æ˜¯ PSA å’Œ LCSR çš„å‡ ä½•å¹³å‡å€¼ï¼Œç”¨äºç»¼åˆè¯„ä¼°æ¨¡å‹æ€§èƒ½ï¼š
\[
\text{GeoMean} = \sqrt{\text{PSA} \times \text{LCSR}}
\]

---

 **æ€»ç»“**
é€šè¿‡è®­ç»ƒå’Œè¯„ä¼°ï¼Œç›®æ ‡æ˜¯ä¼˜åŒ–æ¨¡å‹ï¼Œä½¿å…¶åœ¨ PSAã€LCSR å’Œ GeoMean ä¸Šè¾¾åˆ°è¾ƒé«˜çš„æ€§èƒ½ï¼Œä»è€Œå‡†ç¡®é¢„æµ‹è¾“å…¥åºåˆ—ä¸­çš„è´¨æ•°åºåˆ—ã€‚ ğŸ˜Š





è¿™æ˜¯ä¸€ä¸ªè¡Œå†…å…¬å¼ï¼š$$ x = \frac{-b \pm \sqrt{b^2 - 4ac}}{2a} $$ã€‚


$$
LaTeX_math_expression
$$

<!-- Equation numbering, keep all blank lines  -->

$$
\begin{equation}
  LaTeX_math_expression
  \label{eq:label_name}
\end{equation}
$$

Can be referenced as \eqref{eq:label_name}.

<!-- Inline math in lines, NO blank lines -->

"Lorem ipsum dolor sit amet, $$ LaTeX_math_expression $$ consectetur adipiscing elit."

<!-- Inline math in lists, escape the first `$` -->

1. \$$ LaTeX_math_expression $$
2. \$$ LaTeX_math_expression $$
3. \$$ LaTeX_math_expression $$



---



### **ä»»åŠ¡å®šä¹‰ï¼šè´¨æ•°åºåˆ—æå–ä»»åŠ¡**

#### **è¾“å…¥**
- ä¸€ä¸ªæ•´æ•°åºåˆ— $x = [x_1, x_2, \dots, x_n]$ï¼Œå…¶ä¸­ï¼š
  - åºåˆ—é•¿åº¦ $n \leq \text{max\_length}$ã€‚
  - æ¯ä¸ªæ•´æ•° $x_i$ æ»¡è¶³ $1 \leq x_i \leq \text{cfg.vocab\_size} - 2$ã€‚

#### **è¾“å‡º**
- ä¸€ä¸ªæ•´æ•°åºåˆ— $y = [y_1, y_2, \dots, y_m]$ï¼Œå…¶ä¸­ï¼š
  - è¾“å‡ºåºåˆ— $y$ æ˜¯è¾“å…¥åºåˆ—ä¸­æ‰€æœ‰è´¨æ•°çš„åºåˆ—ã€‚
  - è´¨æ•°å®šä¹‰ä¸ºï¼šå¤§äº 1 ä¸”ä»…èƒ½è¢« 1 å’Œè‡ªèº«æ•´é™¤çš„æ•´æ•°ã€‚
  - è¾“å‡ºåºåˆ—é•¿åº¦ $m \leq n$ã€‚

#### **ä»»åŠ¡ç›®æ ‡**
- è®¾è®¡ä¸€ä¸ª **seq2seq æ¨¡å‹**ï¼Œå­¦ä¹ ä»è¾“å…¥åºåˆ— $x$ æ˜ å°„åˆ°è¾“å‡ºåºåˆ— $y$ çš„è§„åˆ™ã€‚
- æ¨¡å‹é€šè¿‡è®­ç»ƒåï¼Œèƒ½å¤Ÿå‡†ç¡®é¢„æµ‹è¾“å…¥åºåˆ—ä¸­çš„è´¨æ•°åºåˆ—ã€‚

---

### **è®­ç»ƒä¸è¯„ä¼°æµç¨‹**

#### **è®­ç»ƒ**
- è®­ç»ƒæ¨¡å‹è¿›è¡Œå¤šè½®è¿­ä»£ï¼Œæ¯è½®è®­ç»ƒè¿›è¡Œ $\text{steps}$ æ¬¡æ›´æ–°ã€‚
- æ¯æ¬¡è®­ç»ƒåï¼Œæ¨¡å‹ä¼šä¿å­˜å¹¶ç”¨äºè¯„ä¼°ã€‚

#### **è¯„ä¼°**
- è¯„ä¼°æ¨¡å‹çš„æ€§èƒ½æ—¶ï¼Œè¿è¡Œ $\text{evaluate\_round}$ æ¬¡ç‹¬ç«‹è¯„ä¼°ï¼Œç»Ÿè®¡ä»¥ä¸‹æŒ‡æ ‡çš„å¹³å‡å€¼ï¼š
  1. **PSA**ï¼ˆä½ç½®åºåˆ—å‡†ç¡®ç‡ï¼‰
  2. **LCSR**ï¼ˆæœ€é•¿å…¬å…±å­åºåˆ—æ¯”ç‡ï¼‰
  3. **GeoMean**ï¼ˆPSA å’Œ LCSR çš„å‡ ä½•å¹³å‡å€¼ï¼‰

---

### **è¯„ä¼°æŒ‡æ ‡å®šä¹‰**

#### **1. PSAï¼ˆPosition Sequence Accuracyï¼‰**
PSA è¡¡é‡é¢„æµ‹åºåˆ—ä¸ç›®æ ‡åºåˆ—åœ¨æ¯ä¸ªä½ç½®ä¸Šçš„åŒ¹é…ç¨‹åº¦ã€‚å¯¹äºç¬¬ $i$ ä¸ªæ ·æœ¬ï¼š

$
\text{PSA}^{(i)} = \frac{1}{L_i} \sum_{k=1}^{L_i} \delta\left(y_k^{(i)}, \hat{y}_k^{(i)}\right)
$

å…¶ä¸­ï¼š
- $L_i$ï¼šç›®æ ‡åºåˆ— $y^{(i)}$ çš„é•¿åº¦ã€‚
- $\delta(y_k^{(i)}, \hat{y}_k^{(i)})$ï¼šæŒ‡ç¤ºå‡½æ•°ï¼Œå½“ $y_k^{(i)} = \hat{y}_k^{(i)}$ æ—¶å–å€¼ 1ï¼Œå¦åˆ™å–å€¼ 0ã€‚
- $y_k^{(i)}$ï¼šç›®æ ‡åºåˆ—çš„ç¬¬ $k$ ä¸ªå…ƒç´ ã€‚
- $\hat{y}_k^{(i)}$ï¼šé¢„æµ‹åºåˆ—çš„ç¬¬ $k$ ä¸ªå…ƒç´ ã€‚

æ•´ä½“ PSA ä¸ºæ‰€æœ‰æ ·æœ¬çš„å¹³å‡å€¼ï¼š

$
\text{PSA} = \frac{1}{N} \sum_{i=1}^{N} \text{PSA}^{(i)}
$

---

#### **2. LCSRï¼ˆLongest Common Subsequence Ratioï¼‰**
LCSR è¡¡é‡é¢„æµ‹åºåˆ—ä¸ç›®æ ‡åºåˆ—çš„æœ€é•¿å…¬å…±å­åºåˆ—ï¼ˆLCSï¼‰çš„æ¯”ä¾‹ã€‚å¯¹äºç¬¬ $i$ ä¸ªæ ·æœ¬ï¼š

$
\text{LCSR}^{(i)} = \frac{\text{LCS}(y^{(i)}, \hat{y}^{(i)})}{L_i}
$

å…¶ä¸­ï¼š
- $\text{LCS}(y^{(i)}, \hat{y}^{(i)})$ï¼šç›®æ ‡åºåˆ— $y^{(i)}$ å’Œé¢„æµ‹åºåˆ— $\hat{y}^{(i)}$ çš„æœ€é•¿å…¬å…±å­åºåˆ—é•¿åº¦ã€‚
- $L_i$ï¼šç›®æ ‡åºåˆ— $y^{(i)}$ çš„é•¿åº¦ã€‚

æ•´ä½“ LCSR ä¸ºæ‰€æœ‰æ ·æœ¬çš„å¹³å‡å€¼ï¼š

$
\text{LCSR} = \frac{1}{N} \sum_{i=1}^{N} \text{LCSR}^{(i)}
$

---

#### **3. GeoMeanï¼ˆGeometric Meanï¼‰**
GeoMean æ˜¯ PSA å’Œ LCSR çš„å‡ ä½•å¹³å‡å€¼ï¼Œç”¨äºç»¼åˆè¯„ä¼°æ¨¡å‹æ€§èƒ½ï¼š

$
\text{GeoMean} = \sqrt{\text{PSA} \times \text{LCSR}}
$

---

### **æ€»ç»“**
é€šè¿‡è®­ç»ƒå’Œè¯„ä¼°ï¼Œç›®æ ‡æ˜¯ä¼˜åŒ–æ¨¡å‹ï¼Œä½¿å…¶åœ¨ PSAã€LCSR å’Œ GeoMean ä¸Šè¾¾åˆ°è¾ƒé«˜çš„æ€§èƒ½ï¼Œä»è€Œå‡†ç¡®é¢„æµ‹è¾“å…¥åºåˆ—ä¸­çš„è´¨æ•°åºåˆ—ã€‚ ğŸ˜Š